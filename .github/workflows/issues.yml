name: Publish
on: 
  push:
  schedule:
    - cron: '1 * * * *'
jobs:
  dump-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.1

      - name: Get issues
        env:
          REST_API_GITHUB_TOKEN: ${{secrets.REST_API_GITHUB_TOKEN}}
        run: |
          set +e
          _TMPDIR=$(pwd)/tmp.gh-pages.${GITHUB_RUN_ID}
          echo use ${_TMPDIR}

          mkdir -p ${_TMPDIR}

          date | tee ${_TMPDIR}/date.txt

          echo Run issues dump.

          time ./scripts/issues-dump.sh ${_TMPDIR}/issues.csv
          
          if [[ $? != "0" ]] ; then
            cat ${_TMPDIR}/issues.csv
            exit 1
          fi

      - name: Publish CSV
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages 
          folder: tmp.gh-pages.${{ github.run_id }}
          single-commit: true

      - name: Cleanup
        if: always()
        run: |
          _TMPDIR=./tmp.gh-pages.${GITHUB_RUN_ID}
          rm -rf ${_TMPDIR}

